{% extends 'base.html' %}

{% block head %}
<title>Administrar Flotilla</title>
<style>
  .services-container{
    display: flex;
    //margin-top: 30px;
    //margin-left: 20px
  }
  .service{
    text-align: center;
    border: 2px solid #179e0e;
    margin: 5px;
    transition: transform .2s !important; /* Animation */
  }
  .service:hover{
    transform: scale(1.1);
    cursor: pointer;
  }
  .card img{
    width: 50px;
    height: 44px;
  }
  .card{
    text-align: -webkit-center !important;
    width: 140px !important;
    border: none !important;
  }
  .form-perf{
    width: 30%;
    margin: 5px;
  }
  .content-pagination{
    margin: 0 auto;
  }

  tbody {
      display:block;
      height:350px;
      overflow:auto;
  }
  thead, tbody tr {
      display:table;
      width:100%;
      table-layout:fixed;/* even columns width , fix width of table too*/
  }

</style>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
{% endblock %}
{% block body %}
<div class="" style="margin-top: 5px;">
  <h5>Bienvenido! {{user.username}} a VT-Tracker</h5>
</div>
  <div class="container">
    {% if user.is_superuser %}
      <div class="" style="margin: 0px;">
        <!--<a href="javascript:history.back()">Regresar</a>-->
        <h5 style="margin-top: 15px;">Servicios de Flotilla</h5>
      </div>
      <div class="" style="display: inline-flex;">

        <div class="services-container">

          <!--Usuarios-->
          <div class="service" id="user">
            <div class="card" style="width: 18rem;">
              {% load static %}
              <img src="{% static "images/usuario.jpg" %}" class="card-img-top" alt="user">
            </div>
            <div class="card-body">
              <p class="card-text">Usuarios</p>
            </div>
          </div>

          <!--Bitacora-->
          <div class="service" id="binnacle">
            <div class="card" style="width: 18rem;">
              {% load static %}
              <img src="{% static "images/bitacora.png" %}" class="card-img-top" alt="binnacle">
            </div>
            <div class="card-body">
              <p class="card-text">Bitacora</p>
            </div>
          </div>

          <!--Conductores-->
          <div class="service" id="driver">
            <div class="card" style="width: 18rem;">
              {% load static %}
              <img src="{% static "images/conductor.jpeg" %}" class="card-img-top" alt="driver">
            </div>
            <div class="card-body">
              <p class="card-text">Conductores</p>
            </div>
          </div>

          <!--Encomiendas-->
          <div class="service" id="partialService">
            <div class="card" style="width: 18rem;">
              {% load static %}
              <img src="{% static "images/encomienda.png" %}" class="card-img-top" alt="partialService">
            </div>
            <div class="card-body">
              <p class="card-text">Encomiendas</p>
            </div>
          </div>

          <!--Vehiculos-->
          <div class="service" id="vehicle">
            <div class="card" style="width: 18rem;">
              {% load static %}
              <img src="{% static "images/vehiculo.png" %}" class="card-img-top" alt="vehicle">
            </div>
            <div class="card-body">
              <p class="card-text">Vehiculos</p>
            </div>
          </div>

          <!--Recargas-->
          <div class="service" id="refuel">
            <div class="card" style="width: 18rem;">
              {% load static %}
              <img src="{% static "images/recarga2.png" %}" class="card-img-top" alt="refuel">
            </div>
            <div class="card-body">
              <p class="card-text">Recargas</p>
            </div>
          </div>

          <!--Rendimiento-->
          <div class="service" id="performance">
            <div class="card" style="width: 18rem;">
              {% load static %}
              <img src="{% static "images/rendimiento2.jpg" %}" class="card-img-top" alt="performance">
            </div>
            <div class="card-body">
              <p class="card-text">Rendimiento</p>
            </div>
          </div>

        </div>
      </div>
      <hr>
      <div class="" id="content_service">

        <!--Elements for binnacles-->
        <div class="" id="elemBinnacles" style="display: none">
          <div class="" style="display: flex;">
            <h4>Bitacora</h4>
            <a class="btn btn-warning" href="#" style="margin-left: 10px;" id="updateB">Actualizar</a>
          </div>
          <!--filters for searching binnacle-->
          <div class="search-binnacle" style="display: flex;">
            <div class="form-group form-perf">
              <label for="vehicles">Fecha inicio: </label>
              <input type="date" class="form-control" id="startDateB">
            </div>
            <div class="form-group form-perf">
              <label for="vehicles">Fecha fin: </label>
              <input type="date" class="form-control" id="endDateB">
            </div>
            <div class="form-group form-perf">
              <input type="checkbox" name="vehicle" value=""
              class="enableVehicle"> Vehiculo
              <select class="form-control vehicleList" disabled>
                <option value="0">Selecciona una opci贸n</option>
              </select>
            </div>
            <div class="form-group form-perf">
              <label for="vehicles"></label><br>
              <a class="btn btn-success" href="#" id="btnSearchBinnacle">Buscar</a>
            </div>
          </div>
          <div class="form-group">
            <a class="btn btn-outline-danger" href="#" id="exportBinnacle" style="display: none;">Exportar</a>
          </div>
          <!--<a style="width: 20%;" class="btn btn-success" id ="btnNewDriver" data-toggle="modal">Nuevo Conductor</a><br>-->

          <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col"># ID</th>
                <th scope="col">Ruta</th>
                <th scope="col">Fecha</th>
                <th scope="col">Hora de inicio</th>
                <th scope="col">Hora fin</th>
                <th scope="col">Vehiculo</th>
                <th scope="col">Kilometros recorridos</th>
                <th id="thDriver" scope="col">Conductor</th>

              </tr>
            </thead>
            <div class="table-container">
              <tbody id="tbodyBinnacle"></tbody>
            </div>
          </table>

        <br><br><br>

        </div>

        <!--Elements for drivers-->
        <div class="" id="elemDrivers" style="display: none">
          <div class="" style="display: flex;">
            <h4>Conductores Activos</h4>
            <a class="btn btn-warning" href="#" style="margin-left: 10px;" id="updateD">Actualizar</a>
          </div>
          <br>
          <a style="width: 20%;" class="btn btn-success" id ="btnNewDriver" data-toggle="modal">Nuevo Conductor</a><br>
          <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col"># ID</th>
                <th scope="col">Nombre</th>
                <th scope="col">Numero de licencia</th>
                <th scope="col">Fecha expedici贸n</th>
                <th scope="col">Fecha expiraci贸n</th>
                <th scope="col">Telefono</th>
              </tr>
            </thead>
            <tbody id="tbodyDriver"></tbody>
          </table>
        </div>

        <!--Elements for services-->
        <div class="" id="elemServices" style="display: none">
          <div class="" style="display: flex;">
            <h4>Encomiendas</h4>
            <a class="btn btn-warning" href="#" style="margin-left: 10px;" id="updateS">Actualizar</a>
          </div>
          <!--filters for searching services-->
          <div class="search-binnacle" style="display: flex;">
            <div class="form-group form-perf">
              <label for="vehicles">Fecha inicio: </label>
              <input type="date" class="form-control" id="startDateS">
            </div>
            <div class="form-group form-perf">
              <label for="vehicles">Fecha fin: </label>
              <input type="date" class="form-control" id="endDateS">
            </div>
            <div class="form-group form-perf">
              <input type="checkbox" name="vehicle" value=""
              class="enableVehicle"> Vehiculo
              <select class="form-control vehicleList" disabled>
                <option value="0">Selecciona una opci贸n</option>
              </select>
            </div>
            <div class="form-group form-perf">
              <label for="vehicles"></label><br>
              <a class="btn btn-success" href="#" id="btnSearchService">Buscar</a>
            </div>
          </div>
          <div class="form-group">
            <a class="btn btn-outline-danger" href="#" id="exportService" style="display: none;">Exportar</a>
          </div>
          <br>
          <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col"># ID</th>
                <th scope="col">Lugar</th>
                <th scope="col">Solicitante</th>
                <th scope="col">Fecha</th>
                <th scope="col">Hora inicio</th>
                <th scope="col">Hora fin</th>
                <th scope="col">Kilometros recorridos</th>
                <th scope="col">Description</th>
              </tr>
            </thead>
            <tbody id="tbodyServices"></tbody>
          </table>
        </div>

        <!--Elements for Vehicles-->
        <div class="" id="elemVehicles" style="display:none;">
          <div class="" style="display: flex;">
            <h4>Vehiculos Disponibles</h4>
            <a class="btn btn-warning" href="#" style="margin-left: 10px;" id="updateV">Actualizar</a>
          </div>
          <br>
          <a style="display:none; width: 20%;" class="btn btn-success" id ="btnNewVehicle" data-toggle="modal">Nuevo Vehiculo</a>
          <br>
          <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col"># ID</th>
                <th scope="col">Matricula</th>
                <th scope="col">Alias</th>
                <th scope="col">Fecha de Servicio</th>
              </tr>
            </thead>
            <tbody id="tbodyVehicle"></tbody>
          </table>
        </div>

        <!--Elements for Refuel-->
        <div class="" id="elemRefuel" style="display:none;">
          <div class="" style="display: flex;">
            <h4>Recargas de Combustible</h4>
            <a class="btn btn-warning" href="#" style="margin-left: 10px;" id="updateR">Actualizar</a>
          </div>
          <br>
          <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col"># ID</th>
                <th scope="col">Fecha</th>
                <th scope="col">Litros</th>
                <th scope="col">Importe</th>
                <th scope="col">Vehiculo</th>
                <th scope="col">Comprobante</th>
              </tr>
            </thead>
            <tbody id="tbodyRefuel"></tbody>
          </table>
          <br><br><br>
        </div>

        <!--Elements for Users-->
        <div class="" id="elemUsers" style="display:none;">
          <a class="btn btn-success" style="display:none; width:15%;" id ="btnNewUser" href="{% url 'register' %}">Nuevo Usuario</a><br>
          <br>
          <div class="" style="display: flex;">
            <h4>Usuarios registrados</h4>
            <a class="btn btn-warning" href="#" style="margin-left: 10px;" id="updateU">Actualizar</a>
          </div>
          <br>
          <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col"># ID</th>
                <th scope="col">Nombre</th>
                <th scope="col">Email</th>
                <th scope="col">Telefono</th>
                <th scope="col">Direcci贸n</th>
              </tr>
            </thead>
            <tbody id="tbodyUser"></tbody>
          </table>
        </div>

        <!--Elements for performance-->
        <div class="" id="elemPerformance" style="display:none;">
          <h4>Verificar rendimiento</h4>
          <br>
          <div class="form-performance" style="width: 100%; display:flex">
            <div class="form-group form-perf">
              <label for="vehicles">Fecha inicio: </label>
              <input type="date" class="form-control" id="startDateP">
            </div>
            <div class="form-group form-perf">
              <label for="vehicles">Fecha fin: </label>
              <input type="date" class="form-control" id="endDateP">
            </div>
            <!--<div class="form-group form-perf">
              <input type="checkbox" name="vehicle" value=""
               class="enableVehicle"> Vehiculo
              <select class="form-control vehicleList" disabled>
                <option value="0">Selecciona una opci贸n</option>
              </select>
            </div>-->
            <div class="form-group form-perf">
              <label for="vehicles"></label><br>
              <a class="btn btn-success" href="#" id="btnGenerateP">Generar</a>
            </div>
          </div>
          <div class="form-group">
            <a class="btn btn-outline-danger" href="#" id="exportPerformance" style="display: none;">Exportar</a>
          </div>
          <!--<h5 style="color: red;">Seleccionar periodo para ver rendimiento del vehiculo...</h5><br>-->
          <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col">Vehiculo</th>
                <th scope="col">Fecha</th>
                <th scope="col">Litros</th>
                <th scope="col">Kilomentros recorridos</th>
                <th scope="col">Importe</th>
              </tr>
            </thead>
            <tbody id="tbodyPerformance"></tbody>
          </table>
        </div>

        <!-- Modal Driver-->
        <div class="modal fade" id="newDriver" tabindex="-1" role="dialog" aria-labelledby="newDriverLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="newDriverLabel">Asignar nuevo conductor</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
              <form class="" id="formNewDriver" action="{% url 'createDriver' %}" method="post">
                <div class="form-group">
                  <label for="aliasDriver">Nombre o Al铆as: </label>
                  <input type="text" class="form-control" id="aliasDriver" placeholder="Introduce un nombre o al铆as">
                </div>
                <div class="form-group">
                  <label for="users">Usuarios disponibles: </label>
                  <select class="form-control" id="usersList">
                    <option value="0">Selecciona una opci贸n</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="aliasDriver">N煤mero de licencia: </label>
                  <input type="text" class="form-control" id="license_number" placeholder="Introduce el n煤mero de licencia">
                </div>
                <div class="form-group">
                  <label for="aliasDriver">Fecha de expedici贸n: </label>
                  <input type="date" class="form-control" id="license_expedition">
                </div>
                <div class="form-group">
                  <label for="aliasDriver">Fecha de expiraci贸n: </label>
                  <input type="date" class="form-control" id="license_expiration">
                </div>
                </div>
                <div class="modal-footer">
                  <button type="submit" id="btnSaveDriver" class="btn btn-primary">Guardar</button>
                </div>
            </div>
          </div>
        </div>

        <!-- Modal Vehicle-->
        <div class="modal fade" id="newVehicle" tabindex="-1" role="dialog" aria-labelledby="newVehicleLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="newVehicleLabel">Nuevo Vehiculo</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="form-group">
                    <label for="placaVehicle">N煤mero de placa: </label>
                    <input type="text" class="form-control" id="placaVehicle" placeholder="Introduce el n煤mero de placa.">
                  </div>
                  <div class="form-group">
                    <label for="aliasVehicle">Nombre o al铆as del vehiculo: </label>
                    <input type="text" class="form-control" id="aliasVehicle" placeholder="Introduce el nombre o al铆as del vehiculo.">
                  </div>
                  <div class="form-group">
                    <label for="dateServiceVehicle">Fecha de servicio: </label>
                    <input type="date" class="form-control" id="dateServiceVehicle" max="3000-12-31" min="2015-01-01" placeholder="Introduce la ultima fecha de servicio al vehiculo.">
                  </div>
                  <div class="modal-footer">
                    <button type="submit" id="btnSaveVehicle" class="btn btn-primary">Guardar</button>
                  </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    {% endif %}
    {% if not user.is_superuser %}
    <div class="actionsDriver" style="display: grid;">
        <a class="btn btn-danger" href="{% url 'registerBinnacle' %}">Registrar en Bitacora</a>
        <br>
        <a class="btn btn-danger" href="{% url 'registerService' %}">Nueva Encomienda</a>
        <br>
        <a class="btn btn-danger" href="{% url 'registerRefuel' %}">Recarga de Combustible</a>
    </div>
    {% endif %}

  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script>

    var $j = jQuery.noConflict();

    //#############services#######################
    $j('#driver').click(function(){
      let service = $(this);
      cleanContentServices(service);
      setColorSelect(service);
      getDrivers();
    });

    $j('#binnacle').click(function(){
      let service = $(this);
      cleanContentServices(service);
      setColorSelect(service);
      getBinnacles();
      populateVehicles();
    });

    $j('#partialService').click(function(){
      let service = $(this);
      cleanContentServices(service);
      setColorSelect(service);
      getServices();
      populateVehicles();
    });

    $j('#vehicle').click(function(){
      let service = $(this);
      cleanContentServices(service);
      setColorSelect(service);
      getVehicles();

    });

    $j('#user').click(function(){
      let service = $(this);
      cleanContentServices(service);
      setColorSelect(service);
      getUsers();
    });

    $j('#refuel').click(function(){
      let service = $(this);
      cleanContentServices(service);
      setColorSelect(service);
      getRefuels();
    });

    $j('#performance').click(function(){
      let service = $(this);
      cleanContentServices(service);
      setColorSelect(service);
      populateVehicles();

      document.querySelector('#elemPerformance').style.display = "block";
    });

    $j('#btnNewDriver').click(function(e){
      e.preventDefault();

      $j.ajax({
        type: 'GET',
        url: "{% url 'getUsers' %}",
        success: function(response){
          if(response.status){
            let data = JSON.parse(response.data);
            let usersList = $('#usersList');

            for(let i=0; i<data.length; i++){
              let fullname = data[i].fields.name + " " + data[i].fields.lastP + " " + data[i].fields.lastM;
              let idUser = data[i].pk;
              let option = document.createElement('option');

              option.text = fullname;
              option.setAttribute('value', idUser);
              usersList.append(option);
            }
            //show Modal
            $('#newDriver').modal('show');
          }else{
            alert(response.msgError);
          }
        },
        error: function(e){
          console.log(e);
        }
      });


    });

    $j('#btnNewVehicle').click(function(e){
      //show Modal
      $('#newVehicle').modal('show');
    });

    $j('#btnSaveDriver').click(function(e){
      e.preventDefault();
      //validation

      let usersList = document.querySelector('#usersList');

      let driver = {
        'alias': document.querySelector('#aliasDriver').value,
        'fullname': usersList.options[usersList.selectedIndex].text,
        'idUser': usersList.options[usersList.selectedIndex].value,
        'license_number': document.querySelector('#license_number').value,
        'license_expedition': document.querySelector('#license_expedition').value,
        'license_expiration': document.querySelector('#license_expiration').value,
        'csrfmiddlewaretoken': '{{ csrf_token }}',
      };

      saveDriver(driver);

    });

    $j('#btnSaveVehicle').click(function(e){
      e.preventDefault();
      //validation

      let vehicle = {
        'enrollment': document.querySelector('#placaVehicle').value,
        'name': document.querySelector('#aliasVehicle').value,
        'date_service': document.querySelector('#dateServiceVehicle').value,
        'csrfmiddlewaretoken': '{{ csrf_token }}',
      };

      saveVehicle(vehicle);

    });

    $j('#btnSearchBinnacle').click(function(){

      //validation

      let startDateB = document.querySelector('#startDateB').value;
      let endDateB = document.querySelector('#endDateB').value;

      if($j('.enableVehicle').prop('checked')){
        let vehiclesList = document.querySelector('.vehicleList');
        let vehicle = vehiclesList.options[vehiclesList.selectedIndex].value;
        let filter = {
          'startDateB': startDateB,
          'endDateB': endDateB,
          'vehicle': vehicle,
          'option': 'one',
        };

        searchBinnacle(filter);
      }else{
        let filter = {
          'startDateB': startDateB,
          'endDateB': endDateB,
        };

        searchBinnacle(filter);
      }
    });

    $j('#btnSearchService').click(function(){

      let startDateS = document.querySelector('#startDateS').value;
      let endDateS = document.querySelector('#endDateS').value;

      if($j('.enableVehicle').prop('checked')){
        let vehiclesList = document.querySelector('.vehicleList');
        let vehicle = vehiclesList.options[vehiclesList.selectedIndex].value;
        let filter = {
          'startDateS': startDateS,
          'endDateS': endDateS,
          'vehicle': vehicle,
          'option': 'one',
        };

        searchService(filter);
      }else{
        let filter = {
          'startDateS': startDateS,
          'endDateS': endDateS,
        };

        searchService(filter);
      }

    });

    $j('#btnGenerateP').click(function(){

      let startDateP = document.querySelector('#startDateP').value;
      let endDateP = document.querySelector('#endDateP').value;
      let vehiclesList = document.querySelector('.vehicleList');
      let vehicle = vehiclesList.options[vehiclesList.selectedIndex].value;

      let filter ={
        'startDateP': startDateP,
        'endDateP': endDateP,
        'vehicle': vehicle,
        'csrfmiddlewaretoken': '{{ csrf_token }}',
      };

      $j.ajax({
        type: 'POST',
        url: "{% url 'generatePerformance' %}",
        data: filter,
        success: function(response){
          if(response.status){
            console.log(JSON.parse(response.data));
            let data = JSON.parse(response.data);
            //if data is empty
            if(data.length === 0){
              alert('No se encontraron resultados.')
            }

            let tbodyPerf = document.querySelector('#tbodyPerformance');
            let content = "";

            for(let i=0; i<data.length; i++){
              //console.log(data[i]);
              let vehicle = data[i].vehicle;
              let liters = data[i].liters;
              let mileages = data[i].mileages;
              let amount = data[i].amount;

              content += "<tr><td>" + vehicle +
                "</td><td>" + startDateP + " a " + endDateP +
                "</td><td>"  + liters +
                "</td><td>" + mileages +
                "</td><td>" + amount + "</td></tr>";
            }

            tbodyPerf.innerHTML = content;
            //document.querySelector('#elemPerformance').style.display = "block";

          }else{
            alert(response.msgError);
          }
        },
        error: function(e){
          console.log(e);
        }
      });

    });


    //#################utils#######################
    function setColorSelect(service) {
        service.css('backgroundColor','#49a746');
        clearStyle(service.attr('id'));
    }

    function clearStyle(service){
      //services = list of id's for each div that contain one service
      let services = ['binnacle', 'driver', 'partialService', 'vehicle', 'user', 'refuel', 'performance'];
      for(let i=0; i<services.length; i++){
        if(services[i] != $j('#' + service).attr('id')){
          $j('#' + services[i]).css('backgroundColor','');
        }
      }
    }

    function jsonFormat(formArray) {
      let returnArray = {};
      for (let i=0;i<formArray.length;i++) {
          if (formArray[i].value) {
              returnArray[formArray[i].name] = formArray[i].value;
          }
      }
      return returnArray;
    }

    function cleanContentServices(service){

      let idService = service.attr('id');
      //object key= btn_event, value = div_id
      let content_services = {
        "driver": "elemDrivers",
        "vehicle": "elemVehicles",
        "binnacle": "elemBinnacles",
        "partialService": "elemServices",
        "refuel": "elemRefuel",
        "user": "elemUsers",
        "performance": "elemPerformance",
      };

      for(service in content_services){
        if(service != idService){
          let idElements = content_services[service];
          document.querySelector("#" + idElements).style.display = "none";
        }
      }
    }

    $j('#updateB').click(function(){
      document.querySelector('#tbodyBinnacle').innerHTML = '';
      getBinnacles();
    });

    $j('#updateD').click(function(){
      document.querySelector('#tbodyDriver').innerHTML = '';
      getDrivers();
    });

    $j('#updateS').click(function(){
      document.querySelector('#tbodyServices').innerHTML = '';
      getServices();
    });

    $j('#updateV').click(function(){
      document.querySelector('#tbodyVehicle').innerHTML = '';
      getVehicles();
    });

    $j('#updateR').click(function(){
      document.querySelector('#tbodyRefuel').innerHTML = '';
      getRefuels();
    });

    $j('#updateU').click(function(){
      document.querySelector('#tbodyUser').innerHTML = '';
      getUsers();
    });

    $j('.enableVehicle').change(function(){
      if(this.checked){
        $j('.vehicleList').prop('disabled', false);
        $j('.vehicleList').focus();
      }else{
        $j('.vehicleList').prop('disabled', true);
      }
    });

    $j('#exportBinnacle').click(function(){

      let startDateB = $j('#startDateB').val();
      let endDateB = $j('#endDateB').val();
      let data = JSON.parse(localStorage.getItem('dataBinnacles'));
      let json = {
        'binnacles':{
          'binnacle': [

          ]
        }
      };
      let binnacle = [];

      for(let i=0; i<data.length; i++){

        let start_kilometer = data[i].fields.start_kilometer;
        let end_kilometer = data[i].fields.end_kilometer;
        let mileages = parseInt(end_kilometer) - parseInt(start_kilometer);

        data[i].fields['kilometros_recorridos'] = mileages.toString();
        binnacle.push(data[i].fields);
      }
      json.binnacles.binnacle = binnacle;

      //validation
      $j.ajax({
        type: 'POST',
        url: "{% url 'generateFileXml' %}",
        data: {
          'json': JSON.stringify(json),
          'csrfmiddlewaretoken': '{{ csrf_token }}',
          'startDateB': startDateB,
          'endDateB': endDateB,
         },
        success: function(response){
          if(response.status){
            let file_name = 'media/' + response.file_name;
            let a = document.createElement('a');
            a.style.display = 'none';
            a.href = file_name;
            a.download = file_name.slice(7);
            document.body.appendChild(a);
            a.click();

          }else{
            alert(response.msgError);
          }
        },
        error: function(e){
          console.log(e);
        }
      });
    });

    $j('#exportService').click(function(){

      let startDateS = $j('#startDateS').val();
      let endDateS = $j('#endDateS').val();
      let data = JSON.parse(localStorage.getItem('dataServices'));

      let json = {
        'services':{
          'service': [

          ]
        }
      };
      let service = [];

      for(let i=0; i<data.length; i++){

        let start_kilometer = data[i].fields.start_kilometer;
        let end_kilometer = data[i].fields.end_kilometer;
        let mileages = parseInt(end_kilometer) - parseInt(start_kilometer);

        data[i].fields['kilometros_recorridos'] = mileages.toString();
        service.push(data[i].fields);
      }

      json.services.service = service;

      $j.ajax({
        type: 'POST',
        url: "{% url 'generateFileXml' %}",
        data: {
          'json': JSON.stringify(json),
          'csrfmiddlewaretoken': '{{ csrf_token }}',
          'startDateB': startDateS,
          'endDateB': endDateS,
         },
        success: function(response){
          if(response.status){
            let file_name = 'media/' + response.file_name;
            let a = document.createElement('a');
            a.style.display = 'none';
            a.href = file_name;
            a.download = file_name.slice(7);
            document.body.appendChild(a);
            a.click();

          }else{
            alert(response.msgError);
          }
        },
        error: function(e){
          console.log(e);
        }
      });
    });

    //################# funcionts for modal #######################

    function saveDriver(driver){
      let form = $('#formNewDriver');
      $j.ajax({
        data: driver,
        type: form.attr('method'),
        url: form.attr('action'),
        success: function(response){
          console.log(response);
          getDrivers();
          $('#newDriver').modal('hide');
        },
        error: function(response){

        }

      });
    }

    function saveVehicle(vehicle){
      $j.ajax({
        data: vehicle,
        type: "POST",
        url: "{% url 'createVehicle' %}",
        success: function(response){
          console.log(response);
          $('#newVehicle').modal('hide');
          getVehicles()
        },
        error: function(response){

        }

      });
    }

    //################### AJAX Functions ##########################

    function getDrivers(){

      $j.ajax({
        type: 'GET',
        url: "{% url 'getDrivers' %}",
        success: function(response){
          //console.log(response);
          if(response.status){
            let data = JSON.parse(response.data);
            console.log(data);

            //if data is empty
            if(data.length === 0){
              alert('No hay conductores registradas en el sistema.')
            }

            let tbodyDriver = document.querySelector('#tbodyDriver');
            let content = "";

            for(let i=0; i<data.length; i++){

              let pk = data[i].pk;
              let fullname = data[i].fields.user.name;
              let license_number = data[i].fields.license_number;
              let license_expedition = data[i].fields.license_expedition;
              let license_expiration = data[i].fields.license_expiration;
              let phone = data[i].fields.user.phone;

              content += "<tr><td>" + pk +
                "</td><td>" + fullname +
                "</td><td>"  + license_number +
                "</td><td>" + license_expedition +
                  "</td><td>" + license_expiration +
                "</td><td>" + phone + "</td></tr>";
            }

            tbodyDriver.innerHTML = content;
            document.querySelector('#elemDrivers').style.display = "block";
            document.querySelector('#btnNewDriver').style.display = "block";
          }else{
            alert(response.msgError);
          }
        },
        error: function(e){
          console.log(e);
        }
      });
    }

    function populateVehicles(){
      $j.ajax({
        type: 'GET',
        url: "{% url 'getVehicles' %}",
        success: function(response){
          if(response.status){
            let data = JSON.parse(response.data);
            let vehiclesList = $('.vehicleList');

            for(let i=0; i<data.length; i++){
              let vehicle = data[i].fields.alias;
              let option = document.createElement('option');

              option.text = vehicle;
              option.setAttribute('value', data[i].pk);
              vehiclesList.append(option);
            }
          }else{
            alert(response.msgError);
          }
        },
        error: function(e){
          console.log(e);
        }
      });
    }

    function getVehicles(){

      $j.ajax({
        type: "GET",
        url: "{% url 'getVehicles' %}",
        success: function(response){
          //console.log(response);
          if(response.status){
            let data = JSON.parse(response.data);
            console.log(data);
            //if data is empty
            if(data.length === 0){
              alert('No hay vehiculos registradas en el sistema.')
            }

            let tbodyVehicle = document.querySelector('#tbodyVehicle');
            let content = "";

            for(let i=0; i<data.length; i++){
              let pk = data[i].pk;
              let alias = data[i].fields.alias;
              let enrollment = data[i].fields.enrollment;
              let date_service = data[i].fields.data_service;
              date_service = date_service.slice(0,10);

              content += "<tr><td>" + pk +
                "</td><td>" + enrollment +
                "</td><td>"  + alias +
                "</td><td>" + date_service +
                "</td><td>" + " " + "</td></tr>";
            }

            tbodyVehicle.innerHTML = content;
            document.querySelector('#elemVehicles').style.display = "block";
            document.querySelector('#btnNewVehicle').style.display = "block";
          }else{
            alert(response.msgError);
          }
        },
        error: function(e){
          console.log(e);
        }
      });

    }

    function getBinnacles(){

      $j.ajax({
        type: 'GET',
        url: "{% url 'getBinnacles' %}",
        success: function(response){
          //console.log(response);
          if(response.status){
            let data = JSON.parse(response.data);
            //console.log(data);
            //if data is empty
            if(data.length === 0){
              alert('No hay bitacoras registradas en el sistema.')
            }

            let tbodyBinnacle = document.querySelector('#tbodyBinnacle');
            let content = "";

            for(let i=0; i<data.length; i++){

              let start_kilometer = parseInt(data[i].fields.binnacle.start_kilometer);
              let end_kilometer = parseInt(data[i].fields.binnacle.end_kilometer);
              //console.log(data[i]);
              //let pk = data[i].pk;
              let id = i + 1;
              let route = data[i].fields.binnacle.route;
              let start_time = data[i].fields.binnacle.start_time;
              let datetime = data[i].fields.binnacle.datetime.slice(0, 10);
              let end_time = data[i].fields.binnacle.end_time;
              let vehicle = data[i].fields.binnacle.vehicle.alias;
              let mileages = end_kilometer - start_kilometer;
              let driver = data[i].fields.driver.name;

              content += "<tr><td>" + id +
                "</td><td>" + route +
                  "</td><td>"  + datetime +
                "</td><td>"  + start_time +
                "</td><td>" + end_time +
                "</td><td>" + vehicle +
                "</td><td>" + mileages.toString() +
                "</td><td>" + driver + "</td></tr>";
            }

            tbodyBinnacle.innerHTML = content;
            document.querySelector('#elemBinnacles').style.display = "block";
          }else{
            alert(response.msgError);
          }
        },
        error: function(e){
          console.log(e);
        }
      });

    }

    function getServices(){

      $j.ajax({
        type: 'GET',
        url: "{% url 'getServices' %}",
        success: function(response){

          if(response.status){
            let data = JSON.parse(response.data);

            //if data is empty
            if(data.length === 0){
              alert('No hay encomiendas registradas en el sistema.')
            }

            let tbodyServices = document.querySelector('#tbodyServices');
            let content = "";

            for(let i=0; i<data.length; i++){
              //console.log(data[i]);
              //let pk = data[i].pk;
              let end_kilometer = data[i].fields.service.end_kilometer;
              let start_kilometer = data[i].fields.service.start_kilometer;
              let id = i + 1;
              let subject = data[i].fields.service.subject;
              let from_depto = data[i].fields.service.from_depto;
              let datetime = data[i].fields.service.datetime.slice(0,10);
              let start_time = data[i].fields.service.start_time;
              let end_time = data[i].fields.service.end_time;
              //let driver = data[i].fields.driver.name;
              let mileages = parseInt(end_kilometer) - parseInt(start_kilometer)
              let description = data[i].fields.service.description;

              content += "<tr><td>" + id +
                "</td><td>" + subject +
                "</td><td>"  + from_depto +
                "</td><td>" + datetime +
                "</td><td>" + start_time +
                "</td><td>" + end_time +
                "</td><td>" + mileages.toString() +
                "</td><td>" + description + "</td></tr>";
            }

            tbodyServices.innerHTML = content;
            document.querySelector('#elemServices').style.display = "block";
          }else{
            alert(response.msgError);
          }
        },
        error: function(e){
          console.log(e);
        }
      });
    }

    function getRefuels(...args){

      console.log(args.length);

      if(args.length == 0){
        $j.ajax({
          type: 'GET',
          url: "{% url 'getRefuels' %}",
          success: function(response){

            if(response.status){
              let data = JSON.parse(response.data);
              //console.log(data);

              //if data is empty
              if(data.length === 0){
                alert('No hay recargas registradas en el sistema.')
              }

              let tbodyRefuel = document.querySelector('#tbodyRefuel');
              let content = "";

              for(let i=0; i<data.length; i++){
                //console.log(data[i]);
                let pk = data[i].pk;
                let datetime = data[i].fields.datetime.slice(0,10);
                let liters = data[i].fields.liters;
                let amount = data[i].fields.amount;
                let vehicle = data[i].fields.vehicle.name;
                let voucher = data[i].fields.image;

                content += "<tr><td>" + pk +
                  "</td><td>" + datetime +
                  "</td><td>"  + liters +
                  "</td><td>" + amount +
                  "</td><td>" + vehicle +
                  "</td><td><a href='media/" + voucher +
                    "' target='_blank'>Ver comprobante</a></td></tr>";
              }

              tbodyRefuel.innerHTML = content;
              document.querySelector('#elemRefuel').style.display = "block";
            }else{
              alert(response.msgError);
            }
          },
          error: function(e){
            console.log(e);
          }
        });
      }else{

      }



    }

    function getUsers(){

      $j.ajax({
        type: 'GET',
        url: "{% url 'getUsers' %}",
        success: function(response){

          if(response.status){
            let data = JSON.parse(response.data);

            //if data is empty
            if(data.length === 0){
              alert('No hay usuarios registradas en el sistema.')
            }

            let tbodyUser = document.querySelector('#tbodyUser');
            let content = "";

            for(let i=0; i<data.length; i++){
              //console.log(data[i]);
              let pk = data[i].pk;
              let fullname = data[i].fields.name + " " +
              data[i].fields.lastP + " " + data[i].fields.lastM;
              let email = data[i].fields.email;
              let phone = data[i].fields.phone;
              let address = data[i].fields.address;

              content += "<tr><td>" + pk +
                "</td><td>" + fullname +
                "</td><td>"  + email +
                "</td><td>" + phone +
                "</td><td>" + address + "</td></tr>";
            }

            tbodyUser.innerHTML = content;
            document.querySelector('#elemUsers').style.display = "block";
            document.querySelector('#btnNewUser').style.display = "block";
          }else{
            alert(response.msgError);
          }
        },
        error: function(e){
          console.log(e);
        }
      });

    }

    function searchBinnacle(filter){

      $j.ajax({
        type: 'GET',
        url: "{% url 'binnacleSearch' %}",
        data: filter,
        success: function(response){
          if(response.status){
            //console.log(JSON.parse(response.data));
            let data = JSON.parse(response.data);

            if(data.length === 0){
              alert('No se encontraron resultados.')
            }

            document.querySelector('#exportBinnacle').style.display = 'block';
            let tbodyBinnacle = document.querySelector('#tbodyBinnacle');
            let content = "";

            for(let i=0; i<data.length; i++){
              //console.log(data[i]);
              let pk = data[i].pk;
              let route = data[i].fields.route;
              let start_time = data[i].fields.start_time;
              let datetime = data[i].fields.datetime.slice(0, 10);
              let end_time = data[i].fields.end_time;
              let vehicle = data[i].fields.vehicle.name;
              let end_kilometer = data[i].fields.end_kilometer;
              let start_kilometer = data[i].fields.start_kilometer;
              let driver = data[i].fields.driver.name;
              let result_km = parseInt(end_kilometer) - parseInt(start_kilometer);

              content += "<tr><td>" + pk +
                "</td><td>" + route +
                "</td><td>"  + datetime +
                "</td><td>"  + start_time +
                "</td><td>" + end_time +
                "</td><td>" + vehicle +
                "</td><td>" + result_km + ' km' +
                "</td><td>" + driver + "</td></tr>";
            }
            tbodyBinnacle.innerHTML = content;

            localStorage.setItem('dataBinnacles', JSON.stringify(data));

          }else{
            alert(response.msgError);
          }
        },
        error: function(e){
          console.log(e);
        }
      });
    }

    function searchService(filter){

      $j.ajax({
        type: 'GET',
        url: "{% url 'serviceSearch' %}",
        data: filter,
        success: function(response){
          if(response.status){
            //console.log(JSON.parse(response.data));
            let data = JSON.parse(response.data);

            if(data.length === 0){
              alert('No se encontraron resultados.')
            }

            document.querySelector('#exportService').style.display = 'block';
            let tbodyServices = document.querySelector('#tbodyServices');
            let content = "";

            for(let i=0; i<data.length; i++){
              //console.log(data[i]);
              let end_kilometer = data[i].fields.end_kilometer;
              let start_kilometer = data[i].fields.start_kilometer;
              let mileages = parseInt(end_kilometer) - parseInt(start_kilometer);
              let id = i + 1;
              let subject = data[i].fields.subject;
              let from_depto = data[i].fields.from_depto;
              let datetime = data[i].fields.datetime.slice(0,10);
              let start_time = data[i].fields.start_time;
              let end_time = data[i].fields.end_time;
              let description = data[i].fields.description;

              content += "<tr><td>" + id +
                "</td><td>" + subject +
                "</td><td>"  + from_depto +
                "</td><td>" + datetime +
                "</td><td>" + start_time +
                "</td><td>" + end_time +
                "</td><td>" + mileages +
                "</td><td>" + description + "</td></tr>";

            }

            tbodyServices.innerHTML = content;
            localStorage.setItem('dataServices', JSON.stringify(data));

          }else{
            alert(response.msgError);
          }
        },
        error: function(e){
          console.log(e);
        }
      });
    }
  </script>
{% endblock %}
