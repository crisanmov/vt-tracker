{% extends 'base.html' %}

{% block head %}
<title>VTtracker Registrar Recarca Combustible</title>
<style>
  .content-binnacle{
    width: 350px;
  }
</style>
{% endblock %}
{% block body %}
<div class="container">
  <div class="content-binnacle">
    <h5>Recarga de Combustible</h5>
    <br>
    <form class="formRefuel" method="post" id="formSaveRefuel" action="{% url 'registerRefuel'  %}">
      {% csrf_token %}
      <div class="form-group">
        {{form.liters.label_tag}}
        {{form.liters}}
      </div>
      <div class="form-group">
        {{form.amount.label_tag}}
        {{form.amount}}
      </div>
      <div class="form-group">
        {{form.datetime.label_tag}}
        {{form.datetime}}
      </div>
      <div class="form-group">
        <label for="vehicles">Vehiculo: </label>
        <select class="form-control" id="vehiclesList">
          <option value="0">Selecciona una opci√≥n</option>
        </select>
      </div>
      <div class="form-group">
        {{form.image.label_tag}}
        {{form.image}}
      </div>
      <br>
      <div class="btnSaveRefuel">
        <button class="btn btn-info" type="submit" id="btnSaveRefuel">Guardar</button>
      </div>
    </form>
  </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script>
  var $j = jQuery.noConflict();

  getVehicles();

  $j('#datepickerA').attr('type', 'date');

  function jsonFormat(formArray) {
    let returnArray = {};
    for (let i=0;i<formArray.length;i++) {
        if (formArray[i].value) {
            returnArray[formArray[i].name] = formArray[i].value;
        }
    }
    return returnArray;
  }

  function saveRefuel(formData){
    let form = $j('#formSaveRefuel');

    $j.ajax({
      type: form.attr('method'),
      url: form.attr('action'),
      data: formData,
      success: function(response){
        console.log(response);
        if(response.status){
          alert(response.msg);
        }
        else{
          alert(response.errors);
        }
      },
      error: function(e){
        console.log(e);
      }
    });
  }

  function getVehicles(){
    console.log("ssss");
    $j.ajax({
      type: 'GET',
      url: "{% url 'getVehicles' %}",
      success: function(response){
        if(response.status){
          let data = JSON.parse(response.data);
          let vehiclesList = $('#vehiclesList');
          for(let i=0; i<data.length; i++){
            let vehicle = data[i].fields.alias;
            let option = document.createElement('option');

            option.text = vehicle;
            option.setAttribute('value', data[i].pk);
            vehiclesList.append(option);
          }
        }else{
          alert(response.msgError);
        }
      },
      error: function(e){
        console.log(e);
      }
    });
  }

  $j('#btnSaveRefuel').click(function(e){
    e.preventDefault();

    //validation
    let form = $j('#formSaveRefuel');
    let formData = jsonFormat(form.serializeArray());
    let vehiclesList = document.querySelector('#vehiclesList');
    let vehicleSelected = vehiclesList.options[vehiclesList.selectedIndex].value;

    formData['vehicle_id'] = vehicleSelected;
    console.log(formData);

    saveRefuel(formData);
  });

</script>
{% endblock %}
